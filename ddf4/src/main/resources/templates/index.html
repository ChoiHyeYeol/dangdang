<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>회원가입</title>
  <style>
    :root { --green:#10b981; --red:#ef4444; --bg:#0b1020; --card:#121a2e; --muted:#9aa4b2; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Helvetica, Arial, sans-serif; background: var(--bg); color:#eef2ff; }
    .wrap { max-width: 560px; margin: 48px auto; padding: 0 16px; }
    .card { background: var(--card); border: 1px solid rgba(255,255,255,.08); border-radius: 16px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,.2); }
    h1 { margin: 0 0 4px; font-size: 28px; }
    p.sub { margin:0 0 20px; color: var(--muted); }

    form { display: grid; gap: 14px; }
    .row { display: grid; gap: 8px; }
    label { font-size: 14px; color:#c7d2fe; }
    input[type="text"], input[type="password"], input[type="date"] {
      width: 100%; padding: 12px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03); color: #fff; outline: none;
    }
    input::placeholder { color: #9aa4b2; }
    .ctrls { display:flex; gap:10px; align-items:center; justify-content:flex-end; margin-top: 6px; }
    button { padding: 12px 14px; border-radius: 10px; border:1px solid var(--green); background: var(--green); color:#00181a; cursor:pointer; font-weight: 600; }
    button.ghost { background: transparent; color: var(--green); }
    button[disabled] { opacity:.5; cursor:not-allowed; }
    .terms { display:flex; gap:10px; align-items:center; color:#cbd5e1; font-size:14px; }
    .msg { padding: 10px 12px; border-radius: 10px; margin-top: 8px; display:none; }
    .msg.error { background:#2a0e11; color:#fecaca; border:1px solid #7f1d1d; }
    .msg.ok { background:#06281f; color:#a7f3d0; border:1px solid #14532d; }
    .muted { color:#93a3b8; font-size:12px; }
    .pw-toggle { position: relative; }
    .pw-toggle button { position:absolute; right:8px; top:8px; border:1px solid rgba(255,255,255,.16); background: rgba(255,255,255,.06); color:#e2e8f0; padding:6px 8px; border-radius:8px; font-size:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>회원가입</h1>
      <p class="sub">필수 정보를 입력하고 가입을 완료하세요.</p>

      <form id="signupForm" novalidate>
        <div class="row">
          <label for="userId">아이디</label>
          <input id="userId" name="userId" type="text" placeholder="영문/숫자 조합" minlength="3" maxlength="100" required />
        </div>

        <div class="row pw-toggle">
          <label for="userPassword">비밀번호</label>
          <input id="userPassword" name="userPassword" type="password" placeholder="8자 이상 권장" minlength="4" maxlength="255" required />
          <button type="button" id="togglePw" aria-controls="userPassword" aria-label="비밀번호 표시 전환">보기</button>
          <span class="muted">서버에 저장될 때는 해시 처리됩니다.</span>
        </div>

        <div class="row">
          <label for="nickNm">닉네임</label>
          <input id="nickNm" name="nickNm" type="text" placeholder="표시될 이름" maxlength="50" required />
        </div>

        <div class="row">
          <label for="birthDt">생년월일</label>
          <input id="birthDt" name="birthDt" type="date" required />
          <span class="muted">과거 날짜만 선택할 수 있어요.</span>
        </div>

        <div class="row">
          <label for="pregStart">임신일</label>
          <input id="pregStart" name="pregStart" type="date" required />
          <span class="muted">오늘 또는 과거 날짜만 허용됩니다.</span>
        </div>

        <label class="terms">
          <input id="agree" type="checkbox" />
          (필수) 서비스 이용 약관에 동의합니다.
        </label>

        <div id="err" class="msg error" role="alert"></div>
        <div id="ok" class="msg ok" role="status"></div>

        <div class="ctrls">
          <button type="reset" class="ghost">초기화</button>
          <button id="submitBtn" type="submit" disabled>가입 완료</button>
        </div>
      </form>

      <p class="muted" style="margin-top:12px;">이미 계정이 있나요? <a href="/login" style="color:#a7f3d0;">로그인</a></p>
    </div>
  </div>

  <script>
    // 날짜 제한: 오늘까지만 선택 가능 (birthDt/pregStart)
    const today = new Date();
    const toYMD = (d)=>{
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${d.getFullYear()}-${mm}-${dd}`;
    };
    const maxDate = toYMD(today);
    document.getElementById('birthDt').setAttribute('max', maxDate);
    document.getElementById('pregStart').setAttribute('max', maxDate);

    // 약관 동의해야 제출 가능
    const agree = document.getElementById('agree');
    const submitBtn = document.getElementById('submitBtn');
    agree.addEventListener('change',()=>{ submitBtn.disabled = !agree.checked; });

    // 비밀번호 표시 전환
    const togglePwBtn = document.getElementById('togglePw');
    const pwInput = document.getElementById('userPassword');
    togglePwBtn.addEventListener('click',()=>{
      const t = pwInput.type === 'password' ? 'text' : 'password';
      pwInput.type = t; togglePwBtn.textContent = (t==='password'?'보기':'가리기');
    });

    // 폼 제출
    const form = document.getElementById('signupForm');
    const errBox = document.getElementById('err');
    const okBox  = document.getElementById('ok');

    function showMsg(el, text){ if(!text){ el.style.display='none'; el.textContent=''; } else { el.style.display='block'; el.textContent=text; } }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      showMsg(errBox, ''); showMsg(okBox, '');

      // 기본 검증
      const userId = document.getElementById('userId').value.trim();
      const userPassword = pwInput.value;
      const nickNm = document.getElementById('nickNm').value.trim();
      const birthDt = document.getElementById('birthDt').value;
      const pregStart = document.getElementById('pregStart').value;

      if(!userId || !userPassword || !nickNm || !birthDt || !pregStart){
        return showMsg(errBox, '모든 항목을 입력해 주세요.');
      }

      // 과거 날짜 검증
      if(birthDt > maxDate){ return showMsg(errBox, '생년월일은 과거 날짜여야 합니다.'); }
      if(pregStart > maxDate){ return showMsg(errBox, '임신일은 오늘 또는 과거 날짜만 가능합니다.'); }

      const payload = { userId, userPassword, nickNm, birthDt, pregStart };

      submitBtn.disabled = true;
      submitBtn.textContent = '처리 중...';

      try {
        const res = await fetch('/api/userauth/signup', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });

        const text = await res.text();

        if (res.status === 201) {
          showMsg(okBox, text || '회원가입이 완료되었습니다.');
          // 1.5초 후 로그인 페이지로 이동
          setTimeout(()=>{ window.location.href = '/login'; }, 1500);
        } else {
          showMsg(errBox, text || '가입에 실패했습니다. 입력값을 확인해 주세요.');
        }
      } catch (err) {
        showMsg(errBox, '네트워크 오류가 발생했습니다. 잠시 후 다시 시도해 주세요.');
      } finally {
        submitBtn.disabled = !agree.checked;
        submitBtn.textContent = '가입 완료';
      }
    });
  </script>
</body>
</html>
